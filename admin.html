<!DOCTYPE html>
<html>
<head>
  <title>Admin Panel</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #111;
      color: #fff;
      padding: 20px;
    }
    h2 { color: #f0f0f0; }
    input, select, button {
      padding: 10px;
      margin: 5px 0;
      width: 100%;
      max-width: 400px;
    }
    .card {
      background: #222;
      padding: 15px;
      margin-bottom: 20px;
      border-radius: 10px;
    }
    img { max-width: 200px; display: block; margin: 10px 0; }
    .bet-stats { font-size: 14px; }
  </style>
</head>
<body>

<h2>ğŸ¯ Set Result (Red/Green)</h2>
<div class="card">
  <p id="currentPeriod">Loading period...</p>
  <select id="manualResult">
    <option value="">Select Result</option>
    <option value="RED">RED</option>
    <option value="GREEN">GREEN</option>
  </select>
  <button onclick="setResult()">Set Result</button>
</div>

<h2>ğŸ“¤ Deposit Requests</h2>
<div class="card" id="depositList">Loading...</div>

<h2>ğŸ“¥ Withdrawal Requests</h2>
<div class="card" id="withdrawList">Loading...</div>

<h2>ğŸ§¾ Bets (Current Period)</h2>
<div class="card bet-stats" id="betStats">Loading...</div>

<h2>ğŸ–¼ï¸ Upload QR (for Deposit)</h2>
<div class="card">
  <input type="file" accept="image/*" onchange="uploadQR(this)">
  <div id="qrPreview"></div>
</div>

<h2>ğŸ‘¥ All Users</h2>
<div class="card" id="userList">Loading...</div>

<h2>ğŸ’° Add Money to User</h2>
<div class="card">
  <input type="text" id="addNumber" placeholder="Phone Number">
  <input type="number" id="addAmount" placeholder="Amount to Add">
  <button onclick="addMoney()">Add</button>
</div>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyCZFXeJZxc8CJiDz-KBLNKu6JW85LVgYjs",
    authDomain: "yash-first-64655.firebaseapp.com",
    databaseURL: "https://yash-first-64655-default-rtdb.firebaseio.com",
    projectId: "yash-first-64655",
    storageBucket: "yash-first-64655.appspot.com",
    messagingSenderId: "610242949077",
    appId: "1:610242949077:web:216a0905cf9850969f175c"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  function getPeriod(offset = 0) {
    const now = new Date(Date.now() + offset);
    const mins = now.getUTCHours() * 60 + now.getUTCMinutes();
    return now.getUTCFullYear().toString() +
      String(now.getUTCMonth() + 1).padStart(2, '0') +
      String(now.getUTCDate()).padStart(2, '0') + "1000" + (10001 + mins);
  }

  const period = getPeriod();
  document.getElementById("currentPeriod").innerText = "Current Period: " + period;

  function setResult() {
    const res = document.getElementById("manualResult").value;
    if (!res) return alert("Select result first");
    db.ref("manualResults/" + period).set(res);
    alert("Result set for " + period + ": " + res);
  }

  function fetchDeposits() {
    db.ref("deposits").on("value", snap => {
      const list = document.getElementById("depositList");
      list.innerHTML = "";
      snap.forEach(child => {
        const d = child.val();
        if (d.status === "pending") {
          const div = document.createElement("div");
          div.innerHTML = `ğŸ“± ${child.key} - â‚¹${d.amount} - UTR: ${d.utr}
            <button onclick="approveDeposit('${child.key}')">Approve</button>
            <button onclick="rejectDeposit('${child.key}')">Reject</button>`;
          list.appendChild(div);
        }
      });
    });
  }

  function approveDeposit(number) {
    db.ref("users/" + number + "/balance").once("value", snap => {
      let bal = snap.val() || 0;
      db.ref("deposits/" + number).once("value", snap2 => {
        let amt = snap2.val().amount;
        db.ref("users/" + number + "/balance").set(bal + amt);
        db.ref("deposits/" + number + "/status").set("approved");
      });
    });
  }

  function rejectDeposit(number) {
    db.ref("deposits/" + number + "/status").set("rejected");
  }

  function fetchWithdrawals() {
    db.ref("withdrawals").on("value", snap => {
      const list = document.getElementById("withdrawList");
      list.innerHTML = "";
      snap.forEach(child => {
        const d = child.val();
        if (d.status === "pending") {
          const div = document.createElement("div");
          div.innerHTML = `ğŸ“± ${child.key} - â‚¹${d.amount}
            <button onclick="approveWithdraw('${child.key}', ${d.amount})">Approve</button>
            <button onclick="rejectWithdraw('${child.key}')">Reject</button>`;
          list.appendChild(div);
        }
      });
    });
  }

  function approveWithdraw(number, amount) {
    db.ref("withdrawals/" + number + "/status").set("approved");
    db.ref("users/" + number + "/balance").once("value", snap => {
      let bal = snap.val() || 0;
      db.ref("users/" + number + "/balance").set(Math.max(0, bal - amount));
    });
  }

  function rejectWithdraw(number) {
    db.ref("withdrawals/" + number + "/status").set("rejected");
  }

  function showUserList() {
    db.ref("users").on("value", snap => {
      const list = document.getElementById("userList");
      list.innerHTML = "";
      snap.forEach(child => {
        const u = child.val();
        const div = document.createElement("div");
        div.innerHTML = `ğŸ“± ${child.key} - â‚¹${u.balance || 0} - ğŸ”’ ${u.password || "N/A"}`;
        list.appendChild(div);
      });
    });
  }

  function addMoney() {
    const num = document.getElementById("addNumber").value;
    const amt = parseFloat(document.getElementById("addAmount").value);
    if (!num || isNaN(amt)) return alert("Invalid input");
    db.ref("users/" + num + "/balance").once("value", snap => {
      let bal = snap.val() || 0;
      db.ref("users/" + num + "/balance").set(bal + amt);
      alert("Added â‚¹" + amt + " to " + num);
    });
  }

  function uploadQR(input) {
    const file = input.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = e => {
      const imgURL = e.target.result;
      db.ref("qr").set(imgURL);
      document.getElementById("qrPreview").innerHTML = `<img src="${imgURL}" />`;
    };
    reader.readAsDataURL(file);
  }

  function fetchQR() {
    db.ref("qr").on("value", snap => {
      const url = snap.val();
      if (url) document.getElementById("qrPreview").innerHTML = `<img src="${url}" />`;
    });
  }

  function fetchBetStats() {
    db.ref("bets/" + period).on("value", snap => {
      let red = 0, green = 0;
      snap.forEach(child => {
        const b = child.val();
        if (b.color === "RED") red += b.amount;
        if (b.color === "GREEN") green += b.amount;
      });
      document.getElementById("betStats").innerText =
        `RED: â‚¹${red} | GREEN: â‚¹${green}`;
    });
  }

  fetchDeposits();
  fetchWithdrawals();
  showUserList();
  fetchQR();
  fetchBetStats();
</script>
</body>
  </html>
